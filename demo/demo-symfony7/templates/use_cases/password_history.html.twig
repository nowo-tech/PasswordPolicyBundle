{% extends 'use_cases/base.html.twig' %}

{% block title %}Password History - Use Cases{% endblock %}

{% block use_case_title %}Password History Tracking{% endblock %}

{% block use_case_content %}
    {% if user %}
        <div class="info-box info-box-info">
            <h3>Current User: {{ user.email }}</h3>
            <p><strong>Passwords to Remember:</strong> {{ passwordsToRemember }}</p>
            <p><strong>Current History Count:</strong> {{ historyCount }}</p>
        </div>
        
        <h2>Password History</h2>
        {% if history|length > 0 %}
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Created At</th>
                        <th>Password Hash (first 20 chars)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in history %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ entry.createdAt|date('Y-m-d H:i:s') }}</td>
                            <td><code>{{ entry.password|slice(0, 20) }}...</code></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p><em>No password history yet. History is created automatically when you change your password.</em></p>
        {% endif %}
        
        <h2>How It Works</h2>
        <ol>
            <li>When a password is changed, the old password is stored in the password history</li>
            <li>The <code>PasswordEntityListener</code> listens to Doctrine <code>onFlush</code> events</li>
            <li>It automatically creates a new password history entry</li>
            <li>If the history exceeds <code>passwords_to_remember</code>, the oldest entries are removed</li>
            <li>The <code>@PasswordPolicy</code> validator checks against this history to prevent reuse</li>
        </ol>
        
        <div class="info-box info-box-warning">
            <strong>ðŸ’¡ Test It:</strong> 
            <a href="{{ path('user_change_password', {'id': user.id}) }}">Change your password</a> to see a new entry added to the history.
        </div>
    {% else %}
        {% include 'use_cases/_not_authenticated.html.twig' %}
    {% endif %}
{% endblock %}

